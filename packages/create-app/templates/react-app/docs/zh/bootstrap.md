# Bootstrap å¯åŠ¨å™¨

## ğŸ“‹ ç›®å½•

- [ä»€ä¹ˆæ˜¯ Bootstrap](#-ä»€ä¹ˆæ˜¯-bootstrap)
- [ä¸ºä»€ä¹ˆéœ€è¦ Bootstrap](#-ä¸ºä»€ä¹ˆéœ€è¦-bootstrap)
- [æ ¸å¿ƒæ¦‚å¿µ](#-æ ¸å¿ƒæ¦‚å¿µ)
- [å·¥ä½œæµç¨‹](#-å·¥ä½œæµç¨‹)
- [é¡¹ç›®ä¸­çš„å®ç°](#-é¡¹ç›®ä¸­çš„å®ç°)
- [æ’ä»¶ç³»ç»Ÿ](#-æ’ä»¶ç³»ç»Ÿ)
- [å®æˆ˜ç¤ºä¾‹](#-å®æˆ˜ç¤ºä¾‹)
- [æµ‹è¯•ï¼šBootstrap çš„æ ¸å¿ƒä¼˜åŠ¿](#-æµ‹è¯•bootstrap-çš„æ ¸å¿ƒä¼˜åŠ¿)
- [æœ€ä½³å®è·µ](#-æœ€ä½³å®è·µ)
- [å¸¸è§é—®é¢˜](#-å¸¸è§é—®é¢˜)

---

## ğŸ¯ ä»€ä¹ˆæ˜¯ Bootstrap

Bootstrapï¼ˆå¯åŠ¨å™¨ï¼‰æ˜¯åº”ç”¨ç¨‹åºçš„**åˆå§‹åŒ–ç®¡ç†å™¨**ï¼Œè´Ÿè´£åœ¨åº”ç”¨æ¸²æŸ“å‰æ‰§è¡Œæ‰€æœ‰å¿…è¦çš„åˆå§‹åŒ–é€»è¾‘ã€‚

### æ ¸å¿ƒèŒè´£

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Bootstrap å¯åŠ¨å™¨                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ 1. åˆ›å»º IOC å®¹å™¨                            â”‚  â”‚
â”‚  â”‚ 2. æ³¨å…¥ç¯å¢ƒå˜é‡                             â”‚  â”‚
â”‚  â”‚ 3. å°è£…å…¨å±€å˜é‡                             â”‚  â”‚
â”‚  â”‚ 4. æ³¨å†Œä¸šåŠ¡æ’ä»¶                             â”‚  â”‚
â”‚  â”‚ 5. æ‰§è¡Œåˆå§‹åŒ–é€»è¾‘                           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â†“
              åº”ç”¨å¼€å§‹æ¸²æŸ“
```

### ç±»æ¯”ç†è§£

å°±åƒç”µè„‘å¼€æœºæ—¶éœ€è¦ï¼š

- âœ… åŠ è½½é©±åŠ¨ç¨‹åº
- âœ… å¯åŠ¨ç³»ç»ŸæœåŠ¡
- âœ… æ£€æŸ¥ç¡¬ä»¶çŠ¶æ€
- âœ… åˆå§‹åŒ–ç”¨æˆ·ç¯å¢ƒ

Bootstrap åœ¨åº”ç”¨å¯åŠ¨æ—¶åšç±»ä¼¼çš„äº‹æƒ…ï¼š

- âœ… åˆå§‹åŒ– IOC å®¹å™¨ï¼ˆä¾èµ–ç®¡ç†ï¼‰
- âœ… æ³¨å…¥ç¯å¢ƒé…ç½®
- âœ… å°è£…æµè§ˆå™¨ API
- âœ… æ‰§è¡Œä¸šåŠ¡åˆå§‹åŒ–ï¼ˆç”¨æˆ·è®¤è¯ã€API é…ç½®ç­‰ï¼‰

---

## ğŸ¤” ä¸ºä»€ä¹ˆéœ€è¦ Bootstrap

### é—®é¢˜ï¼šä¼ ç»Ÿæ–¹å¼çš„ç—›ç‚¹

#### ç¤ºä¾‹ 1ï¼šç»„ä»¶ä¸­æ··æ‚åˆå§‹åŒ–é€»è¾‘

```typescript
// âŒ ä¼ ç»Ÿæ–¹å¼ï¼šåœ¨ç»„ä»¶ä¸­å¤„ç†åˆå§‹åŒ–
function App() {
  const [loading, setLoading] = useState(true);
  const [user, setUser] = useState(null);
  const [error, setError] = useState(null);

  useEffect(() => {
    // åˆå§‹åŒ–é€»è¾‘æ··åœ¨ç»„ä»¶ä¸­
    fetchUserInfo()
      .then(user => {
        setUser(user);
        // è¿˜è¦æ£€æŸ¥æƒé™
        if (!user.hasPermission) {
          window.location.href = '/login';
        }
      })
      .catch(error => {
        setError(error);
      })
      .finally(() => {
        setLoading(false);
      });
  }, []);

  if (loading) return <div>Loading...</div>;
  if (error) return <div>Error: {error.message}</div>;

  return <Router />;
}
```

**é—®é¢˜ï¼š**

- ğŸ˜° **ç»„ä»¶èŒè´£è¿‡é‡**ï¼šUI ç»„ä»¶ä¸åº”è¯¥å¤„ç†ä¸šåŠ¡åˆå§‹åŒ–
- ğŸ˜° **çŠ¶æ€ç®¡ç†å¤æ‚**ï¼šéœ€è¦ç®¡ç†å¤šä¸ªçŠ¶æ€ï¼ˆloadingã€userã€errorï¼‰
- ğŸ˜° **éš¾ä»¥æµ‹è¯•**ï¼šåˆå§‹åŒ–é€»è¾‘å’Œ UI é€»è¾‘è€¦åˆ
- ğŸ˜° **éš¾ä»¥å¤ç”¨**ï¼šåˆå§‹åŒ–é€»è¾‘æ— æ³•åœ¨å…¶ä»–é¡¹ç›®ä¸­å¤ç”¨
- ğŸ˜° **ç»´æŠ¤å›°éš¾**ï¼šä¸šåŠ¡é€»è¾‘å˜åŒ–ä¼šå½±å“ç»„ä»¶ç»“æ„

#### ç¤ºä¾‹ 2ï¼šå¤šæ¡ä»¶åˆå§‹åŒ–

```typescript
// âŒ æ›´å¤æ‚çš„åœºæ™¯ï¼šå¤šä¸ªåˆå§‹åŒ–æ­¥éª¤
function App() {
  const [loading, setLoading] = useState(true);
  const [userInfo, setUserInfo] = useState(null);
  const [permissions, setPermissions] = useState([]);
  const [i18nLoaded, setI18nLoaded] = useState(false);
  const [apiConfigured, setApiConfigured] = useState(false);
  const location = useLocation();

  useEffect(() => {
    const init = async () => {
      try {
        // æ­¥éª¤ 1ï¼šé…ç½® API
        await configureAPI();
        setApiConfigured(true);

        // æ­¥éª¤ 2ï¼šåŠ è½½å›½é™…åŒ–
        await loadI18n();
        setI18nLoaded(true);

        // æ­¥éª¤ 3ï¼šæ£€æŸ¥ç”¨æˆ·è®¤è¯
        if (location.pathname !== '/login') {
          const user = await fetchUserInfo();
          setUserInfo(user);

          // æ­¥éª¤ 4ï¼šåŠ è½½æƒé™
          const perms = await fetchPermissions(user.id);
          setPermissions(perms);

          // æ­¥éª¤ 5ï¼šæƒé™æ£€æŸ¥
          if (!hasRequiredPermission(perms, location.pathname)) {
            window.location.href = '/403';
            return;
          }
        }
      } catch (error) {
        console.error('Initialization failed:', error);
        window.location.href = '/error';
      } finally {
      setLoading(false);
    }
    };

    init();
  }, [location.pathname]);

  // è¿˜è¦å¤„ç†å„ç§åŠ è½½çŠ¶æ€...
  if (loading || !apiConfigured || !i18nLoaded) {
    return <LoadingScreen />;
  }

  return <Router />;
}
```

**é—®é¢˜è¿›ä¸€æ­¥æ¶åŒ–ï¼š**

- ğŸ˜°ğŸ˜°ğŸ˜° **çŠ¶æ€çˆ†ç‚¸**ï¼šéœ€è¦ç®¡ç†å¤šä¸ªåˆå§‹åŒ–çŠ¶æ€
- ğŸ˜°ğŸ˜°ğŸ˜° **éš¾ä»¥æ‰©å±•**ï¼šæ·»åŠ æ–°çš„åˆå§‹åŒ–æ­¥éª¤ä¼šè®©ä»£ç æ›´å¤æ‚
- ğŸ˜°ğŸ˜°ğŸ˜° **é”™è¯¯å¤„ç†å¤æ‚**ï¼šæ¯ä¸€æ­¥éƒ½å¯èƒ½å¤±è´¥ï¼Œéœ€è¦å¤§é‡é”™è¯¯å¤„ç†ä»£ç 
- ğŸ˜°ğŸ˜°ğŸ˜° **ä¾èµ–å…³ç³»éšå¼**ï¼šæ­¥éª¤ä¹‹é—´çš„ä¾èµ–å…³ç³»ä¸æ¸…æ™°

### è§£å†³æ–¹æ¡ˆï¼šä½¿ç”¨ Bootstrap

```typescript
// âœ… ä½¿ç”¨ Bootstrapï¼šç»„ä»¶å˜å¾—ç®€æ´
function App() {
  return (
    <BootstrapsProvider>
      <ComboProvider themeConfig={themeConfig}>
        <AppRouterProvider pages={allPages} />
      </ComboProvider>
    </BootstrapsProvider>
  );
}

// æ‰€æœ‰åˆå§‹åŒ–é€»è¾‘åœ¨ Bootstrap ä¸­å¤„ç†
const bootstrap = new Bootstrap({
  root: window,
  logger,
  ioc: { manager: IOC, register: new IocRegisterImpl({ pathname, appConfig }) },
  envOptions: { /* ç¯å¢ƒå˜é‡é…ç½® */ },
  globalOptions: { /* å…¨å±€å˜é‡é…ç½® */ }
});

// æ³¨å†Œåˆå§‹åŒ–æ’ä»¶
bootstrap.use([
  IOC(I18nService),        // å›½é™…åŒ–æœåŠ¡
  new UserApiBootstrap(),  // ç”¨æˆ· API é…ç½®
  new FeApiBootstrap(),    // ä¸šåŠ¡ API é…ç½®
  IOC(UserService)         // ç”¨æˆ·è®¤è¯æœåŠ¡
]);

// å¯åŠ¨åº”ç”¨
await bootstrap.initialize();
await bootstrap.start();
```

**ä¼˜åŠ¿ï¼š**

- âœ… **ç»„ä»¶èŒè´£æ¸…æ™°**ï¼šUI ç»„ä»¶åªè´Ÿè´£æ¸²æŸ“
- âœ… **é€»è¾‘åˆ†ç¦»**ï¼šåˆå§‹åŒ–é€»è¾‘ç‹¬ç«‹äº UI
- âœ… **æ˜“äºæµ‹è¯•**ï¼šå¯ä»¥ç‹¬ç«‹æµ‹è¯•æ¯ä¸ªåˆå§‹åŒ–æ­¥éª¤
- âœ… **æ˜“äºæ‰©å±•**ï¼šæ·»åŠ æ–°çš„åˆå§‹åŒ–æ­¥éª¤åªéœ€æ·»åŠ æ–°æ’ä»¶
- âœ… **æ˜“äºå¤ç”¨**ï¼šåŒä¸€å¥—åˆå§‹åŒ–é€»è¾‘å¯ä»¥åœ¨ä¸åŒé¡¹ç›®ä¸­ä½¿ç”¨

---

## ğŸ’¡ æ ¸å¿ƒæ¦‚å¿µ

### 1. æ’ä»¶åŒ–æ¶æ„

Bootstrap é‡‡ç”¨æ’ä»¶åŒ–è®¾è®¡ï¼Œæ¯ä¸ªæ’ä»¶è´Ÿè´£ä¸€ä¸ªç‰¹å®šçš„åˆå§‹åŒ–ä»»åŠ¡ã€‚

```typescript
// æ’ä»¶æ¥å£
export interface BootstrapExecutorPlugin {
  readonly pluginName: string;

  // åœ¨åˆå§‹åŒ–å‰æ‰§è¡Œ
  onBefore?(context: BootstrapContext): void | Promise<void>;

  // åœ¨åˆå§‹åŒ–æ—¶æ‰§è¡Œ
  onExecute?(context: BootstrapContext): void | Promise<void>;

  // åœ¨åˆå§‹åŒ–åæ‰§è¡Œ
  onAfter?(context: BootstrapContext): void | Promise<void>;

  // é”™è¯¯å¤„ç†
  onError?(error: Error, context: BootstrapContext): void | Promise<void>;
}
```

### 2. ç”Ÿå‘½å‘¨æœŸ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Bootstrap ç”Ÿå‘½å‘¨æœŸ                             â”‚
â”‚                                                â”‚
â”‚  initialize()                                  â”‚
â”‚  â”œâ”€â”€ åˆ›å»º IOC å®¹å™¨                              â”‚
â”‚  â”œâ”€â”€ æ³¨å…¥ç¯å¢ƒå˜é‡                               â”‚
â”‚  â””â”€â”€ å°è£…å…¨å±€å˜é‡                               â”‚
â”‚                                                â”‚
â”‚  start()                                       â”‚
â”‚  â”œâ”€â”€ onBefore: å‰ç½®åˆå§‹åŒ–                       â”‚
â”‚  â”‚   â”œâ”€â”€ é…ç½® API                               â”‚
â”‚  â”‚   â”œâ”€â”€ åŠ è½½å›½é™…åŒ–                             â”‚
â”‚  â”‚   â””â”€â”€ æ£€æŸ¥ç”¨æˆ·è®¤è¯                           â”‚
â”‚  â”‚                                              â”‚
â”‚  â”œâ”€â”€ onExecute: æ‰§è¡Œä¸»é€»è¾‘                      â”‚
â”‚  â”‚   â””â”€â”€ æ‰§è¡Œä¸šåŠ¡åˆå§‹åŒ–                         â”‚
â”‚  â”‚                                              â”‚
â”‚  â”œâ”€â”€ onAfter: åç½®å¤„ç†                          â”‚
â”‚  â”‚   â””â”€â”€ æ¸…ç†èµ„æºã€è®°å½•æ—¥å¿—                     â”‚
â”‚  â”‚                                              â”‚
â”‚  â””â”€â”€ onError: é”™è¯¯å¤„ç†                          â”‚
â”‚      â””â”€â”€ é”™è¯¯æ•è·å’Œå¤„ç†                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3. ä¾èµ–æ³¨å…¥

Bootstrap ä¸ IOC å®¹å™¨æ·±åº¦é›†æˆï¼Œæ‰€æœ‰æ’ä»¶éƒ½å¯ä»¥é€šè¿‡ä¾èµ–æ³¨å…¥è·å–æœåŠ¡ã€‚

```typescript
@injectable()
export class UserService implements ExecutorPlugin {
  readonly pluginName = 'UserService';

  constructor(
    @inject(UserApi) private api: UserApi,
    @inject(IOCIdentifier.AppConfig) private config: AppConfig,
    @inject(IOCIdentifier.LocalStorageEncrypt) private storage: Storage
  ) {}

  async onBefore(): Promise<void> {
    // ä½¿ç”¨æ³¨å…¥çš„ä¾èµ–æ‰§è¡Œåˆå§‹åŒ–
    const token = this.storage.getItem('token');
    if (token) {
      await this.api.getUserInfo(token);
    }
  }
}
```

---

## ğŸ”„ å·¥ä½œæµç¨‹

### å®Œæ•´æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. main.tsx: åº”ç”¨å…¥å£                                         â”‚
â”‚    BootstrapClient.main({ root: window, bootHref, ioc })   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. BootstrapClient: åˆ›å»º Bootstrap å®ä¾‹                      â”‚
â”‚    - åˆ›å»º IOC å®¹å™¨                                            â”‚
â”‚    - é…ç½®ç¯å¢ƒå˜é‡æ³¨å…¥                                         â”‚
â”‚    - é…ç½®å…¨å±€å˜é‡å°è£…                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. Bootstrap.initialize(): åˆå§‹åŒ–                           â”‚
â”‚    âœ… IOC å®¹å™¨åˆå§‹åŒ–                                          â”‚
â”‚    âœ… ç¯å¢ƒå˜é‡æ³¨å…¥åˆ° AppConfig                                â”‚
â”‚    âœ… å…¨å±€å˜é‡å°è£…ï¼ˆlocalStorageã€window ç­‰ï¼‰                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. BootstrapsRegistry: æ³¨å†Œä¸šåŠ¡æ’ä»¶                          â”‚
â”‚    - I18nService: å›½é™…åŒ–æœåŠ¡                                  â”‚
â”‚    - UserApiBootstrap: ç”¨æˆ· API é…ç½®                         â”‚
â”‚    - FeApiBootstrap: ä¸šåŠ¡ API é…ç½®                           â”‚
â”‚    - UserService: ç”¨æˆ·è®¤è¯æœåŠ¡                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. Bootstrap.start(): å¯åŠ¨                                   â”‚
â”‚    â†“                                                         â”‚
â”‚    onBefore é˜¶æ®µï¼š                                           â”‚
â”‚    â”œâ”€â”€ I18nService.onBefore() â†’ åŠ è½½ç¿»è¯‘èµ„æº                 â”‚
â”‚    â”œâ”€â”€ UserApiBootstrap.onBefore() â†’ é…ç½® API æ’ä»¶          â”‚
â”‚    â”œâ”€â”€ FeApiBootstrap.onBefore() â†’ é…ç½®ä¸šåŠ¡ API             â”‚
â”‚    â””â”€â”€ UserService.onBefore() â†’ æ£€æŸ¥ç”¨æˆ·è®¤è¯                 â”‚
â”‚    â†“                                                         â”‚
â”‚    onExecute é˜¶æ®µï¼š                                          â”‚
â”‚    â””â”€â”€ æ‰§è¡Œæ’ä»¶ä¸»é€»è¾‘                                         â”‚
â”‚    â†“                                                         â”‚
â”‚    onAfter é˜¶æ®µï¼š                                            â”‚
â”‚    â””â”€â”€ æ¸…ç†å’Œæ—¥å¿—è®°å½•                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. React æ¸²æŸ“                                                â”‚
â”‚    ReactDOM.render(<App />)                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ› ï¸ é¡¹ç›®ä¸­çš„å®ç°

### æ–‡ä»¶ç»“æ„

```
src/
â”œâ”€â”€ main.tsx                          # åº”ç”¨å…¥å£
â”œâ”€â”€ core/
â”‚   â”œâ”€â”€ bootstraps/
â”‚   â”‚   â”œâ”€â”€ BootstrapClient.ts        # Bootstrap å¯åŠ¨å™¨
â”‚   â”‚   â”œâ”€â”€ BootstrapsRegistry.ts     # æ’ä»¶æ³¨å†Œå™¨
â”‚   â”‚   â”œâ”€â”€ PrintBootstrap.ts         # æ‰“å°æ—¥å¿—æ’ä»¶
â”‚   â”‚   â””â”€â”€ IocIdentifierTest.ts      # IOC æµ‹è¯•æ’ä»¶
â”‚   â”œâ”€â”€ globals.ts                    # å…¨å±€å˜é‡å°è£…
â”‚   â””â”€â”€ clientIoc/
â”‚       â”œâ”€â”€ ClientIOC.ts              # IOC å®¹å™¨
â”‚       â””â”€â”€ ClientIOCRegister.ts      # IOC æ³¨å†Œå™¨
â”œâ”€â”€ base/
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”œâ”€â”€ UserService.ts            # ç”¨æˆ·æœåŠ¡ï¼ˆæ’ä»¶ï¼‰
â”‚   â”‚   â””â”€â”€ I18nService.ts            # å›½é™…åŒ–æœåŠ¡ï¼ˆæ’ä»¶ï¼‰
â”‚   â””â”€â”€ apis/
â”‚       â”œâ”€â”€ userApi/
â”‚       â”‚   â””â”€â”€ UserApiBootstrap.ts   # ç”¨æˆ· API é…ç½®æ’ä»¶
â”‚       â””â”€â”€ feApi/
â”‚           â””â”€â”€ FeApiBootstrap.ts     # ä¸šåŠ¡ API é…ç½®æ’ä»¶
â””â”€â”€ uikit/
    â””â”€â”€ components/
        â””â”€â”€ BootstrapsProvider.tsx    # Bootstrap Provider
```

### 1. å…¥å£æ–‡ä»¶ï¼šmain.tsx

```typescript
// src/main.tsx
import 'reflect-metadata';
import { StrictMode } from 'react';
import { createRoot } from 'react-dom/client';
import App from './App.tsx';
import { BootstrapClient } from './core/bootstraps/BootstrapClient';
import { clientIOC } from './core/clientIoc/ClientIOC.ts';

// ğŸš€ å¯åŠ¨ Bootstrap
BootstrapClient.main({
  root: window,                    // æ³¨å…¥æµè§ˆå™¨ç¯å¢ƒ
  bootHref: window.location.href,  // æ³¨å…¥å¯åŠ¨ URL
  ioc: clientIOC                   // æ³¨å…¥ IOC å®¹å™¨
});

// æ¸²æŸ“ React åº”ç”¨
createRoot(document.getElementById('root')!).render(
  <StrictMode>
    <App />
  </StrictMode>
);
```

### 2. Bootstrap å¯åŠ¨å™¨ï¼šBootstrapClient.ts

```typescript
// src/core/bootstraps/BootstrapClient.ts
import { Bootstrap } from '@qlover/corekit-bridge';
import { envBlackList, envPrefix, browserGlobalsName } from '@config/common';
import * as globals from '../globals';
import { BootstrapsRegistry } from './BootstrapsRegistry';

export class BootstrapClient {
  static async main(args: BootstrapClientArgs): Promise<BootstrapClientArgs> {
    const { root, bootHref, ioc, iocRegister } = args;
    const { logger, appConfig } = globals;

    // 1ï¸âƒ£ åˆ›å»º IOC å®¹å™¨
    const IOC = ioc.create({
      pathname: bootHref,
      appConfig: appConfig
    });

    // 2ï¸âƒ£ åˆ›å»º Bootstrap å®ä¾‹
    const bootstrap = new Bootstrap({
      root,
      logger,
      // IOC å®¹å™¨é…ç½®
      ioc: {
        manager: IOC,
        register: iocRegister
      },
      // ç¯å¢ƒå˜é‡æ³¨å…¥é…ç½®
      envOptions: {
        target: appConfig, // æ³¨å…¥åˆ° AppConfig
        source: Object.assign({}, import.meta.env, {
          [envPrefix + 'BOOT_HREF']: bootHref // æ·»åŠ å¯åŠ¨ URL
        }),
        prefix: envPrefix, // ç¯å¢ƒå˜é‡å‰ç¼€
        blackList: envBlackList // é»‘åå•
      },
      // å…¨å±€å˜é‡å°è£…é…ç½®
      globalOptions: {
        sources: globals, // å°è£…çš„å…¨å±€å˜é‡
        target: browserGlobalsName // æŒ‚è½½ç›®æ ‡
      }
    });

    try {
      logger.info('bootstrap start...');

      // 3ï¸âƒ£ åˆå§‹åŒ– Bootstrap
      await bootstrap.initialize();

      // 4ï¸âƒ£ æ³¨å†Œä¸šåŠ¡æ’ä»¶
      const bootstrapsRegistry = new BootstrapsRegistry(IOC);

      // 5ï¸âƒ£ å¯åŠ¨åº”ç”¨
      await bootstrap.use(bootstrapsRegistry.register()).start();

      logger.info('bootstrap completed successfully');
    } catch (error) {
      logger.error(`${appConfig.appName} startup error:`, error);
    }

    return args;
  }
}
```

**å…³é”®æ­¥éª¤è§£æï¼š**

1. **åˆ›å»º IOC å®¹å™¨** - ç»Ÿä¸€ç®¡ç†æ‰€æœ‰ä¾èµ–
2. **åˆ›å»º Bootstrap å®ä¾‹** - é…ç½®åˆå§‹åŒ–å‚æ•°
3. **åˆå§‹åŒ–** - æ‰§è¡Œ IOCã€ç¯å¢ƒå˜é‡ã€å…¨å±€å˜é‡çš„åˆå§‹åŒ–
4. **æ³¨å†Œæ’ä»¶** - æ·»åŠ ä¸šåŠ¡åˆå§‹åŒ–é€»è¾‘
5. **å¯åŠ¨** - æ‰§è¡Œæ‰€æœ‰æ’ä»¶çš„ç”Ÿå‘½å‘¨æœŸæ–¹æ³•

### 3. æ’ä»¶æ³¨å†Œå™¨ï¼šBootstrapsRegistry.ts

```typescript
// src/core/bootstraps/BootstrapsRegistry.ts
import { IOCIdentifier } from '@config/IOCIdentifier';
import { UserApiBootstarp } from '@/base/apis/userApi/UserApiBootstarp';
import { FeApiBootstarp } from '@/base/apis/feApi/FeApiBootstarp';
import { AiApiBootstarp } from '@/base/apis/AiApi';

export class BootstrapsRegistry {
  constructor(
    protected IOC: IOCFunctionInterface<IOCIdentifierMap, IOCContainerInterface>
  ) {}

  get appConfig(): EnvConfigInterface {
    return this.IOC(IOCIdentifier.AppConfig);
  }

  /**
   * æ³¨å†Œæ‰€æœ‰ä¸šåŠ¡æ’ä»¶
   */
  register(): BootstrapExecutorPlugin[] {
    const IOC = this.IOC;

    const bootstrapList = [
      // 1. å›½é™…åŒ–æœåŠ¡ï¼ˆéœ€è¦æœ€å…ˆåˆå§‹åŒ–ï¼‰
      IOC(IOCIdentifier.I18nServiceInterface),

      // 2. API é…ç½®æ’ä»¶
      new UserApiBootstarp(), // ç”¨æˆ· API
      new FeApiBootstarp(), // ä¸šåŠ¡ API
      AiApiBootstarp, // AI API

      // 3. å…¶ä»–æ’ä»¶
      IOC(IOCIdentifier.I18nKeyErrorPlugin),
      IOC(IOCIdentifier.ProcesserExecutorInterface)
    ];

    // å¼€å‘ç¯å¢ƒï¼šæ·»åŠ è°ƒè¯•æ’ä»¶
    if (!this.appConfig.isProduction) {
      bootstrapList.push(printBootstrap);
    }

    return bootstrapList;
  }
}
```

**æ’ä»¶é¡ºåºå¾ˆé‡è¦ï¼š**

- âœ… å›½é™…åŒ–æœåŠ¡æœ€å…ˆåˆå§‹åŒ–ï¼ˆå…¶ä»–æ’ä»¶å¯èƒ½éœ€è¦ç¿»è¯‘ï¼‰
- âœ… API é…ç½®åœ¨ä¸šåŠ¡é€»è¾‘ä¹‹å‰
- âœ… å¼€å‘å·¥å…·ä»…åœ¨å¼€å‘ç¯å¢ƒåŠ è½½

---

## ğŸ”Œ æ’ä»¶ç³»ç»Ÿ

### æ’ä»¶ç±»å‹

#### 1. æœåŠ¡ç±»æ’ä»¶ï¼ˆé€šè¿‡ IOC æ³¨å…¥ï¼‰

```typescript
// src/base/services/I18nService.ts
@injectable()
export class I18nService implements ExecutorPlugin {
  readonly pluginName = 'I18nService';

  constructor(@inject(IOCIdentifier.AppConfig) private config: AppConfig) {}

  /**
   * åœ¨ Bootstrap å¯åŠ¨å‰åŠ è½½ç¿»è¯‘èµ„æº
   */
  async onBefore(): Promise<void> {
    await i18next.init({
      lng: this.config.defaultLanguage,
      fallbackLng: 'en',
      resources: this.loadResources()
    });
  }

  private loadResources() {
    // åŠ è½½ç¿»è¯‘èµ„æº
    return {
      /* ... */
    };
  }
}

// æ³¨å†Œæ–¹å¼
bootstrap.use([
  IOC(IOCIdentifier.I18nServiceInterface) // ä» IOC å®¹å™¨è·å–
]);
```

#### 2. é…ç½®ç±»æ’ä»¶ï¼ˆç‹¬ç«‹å®ä¾‹ï¼‰

```typescript
// src/base/apis/userApi/UserApiBootstrap.ts
export class UserApiBootstarp implements BootstrapExecutorPlugin {
  readonly pluginName = 'UserApiBootstarp';

  /**
   * é…ç½® User API çš„æ’ä»¶
   */
  onBefore({ parameters: { ioc } }: BootstrapContext): void {
    const userApi = ioc.get<UserApi>(UserApi);

    // æ·»åŠ  URL å¤„ç†æ’ä»¶
    userApi.usePlugin(new FetchURLPlugin());

    // æ·»åŠ  Mock æ’ä»¶ï¼ˆå¼€å‘ç¯å¢ƒï¼‰
    userApi.usePlugin(ioc.get(IOCIdentifier.ApiMockPlugin));

    // æ·»åŠ è¯·æ±‚æ—¥å¿—æ’ä»¶
    userApi.usePlugin(ioc.get(RequestLogger));
  }
}

// æ³¨å†Œæ–¹å¼
bootstrap.use([
  new UserApiBootstarp() // ç›´æ¥åˆ›å»ºå®ä¾‹
]);
```

#### 3. ä¸šåŠ¡é€»è¾‘æ’ä»¶

```typescript
// src/base/services/UserService.ts
@injectable()
export class UserService
  extends UserAuthService<UserInfo>
  implements ExecutorPlugin
{
  readonly pluginName = 'UserService';

  constructor(
    @inject(IOCIdentifier.RouteServiceInterface)
    protected routerService: RouteServiceInterface,
    @inject(UserApi)
    userApi: UserAuthApiInterface<UserInfo>,
    @inject(IOCIdentifier.AppConfig) appConfig: AppConfig,
    @inject(IOCIdentifier.LocalStorageEncrypt)
    storage: SyncStorageInterface<string, string>
  ) {
    super(userApi, {
      userStorage: {
        key: appConfig.userInfoStorageKey,
        storage: storage
      },
      credentialStorage: {
        key: appConfig.userTokenStorageKey,
        storage: storage
      }
    });
  }

  /**
   * åœ¨åº”ç”¨å¯åŠ¨æ—¶æ£€æŸ¥ç”¨æˆ·è®¤è¯çŠ¶æ€
   */
  async onBefore(): Promise<void> {
    // å¦‚æœå·²ç™»å½•ï¼Œç›´æ¥è¿”å›
    if (this.isAuthenticated()) {
      return;
    }

    // å°è¯•ä»å­˜å‚¨ä¸­æ¢å¤ç”¨æˆ·ä¿¡æ¯
    const userToken = this.getToken();
    if (!userToken) {
      throw new AppError('NO_USER_TOKEN');
    }

    // è·å–ç”¨æˆ·ä¿¡æ¯
    await this.userInfo();
  }

  getToken(): string | null {
    return this.credential();
  }
}
```

### æ’ä»¶ç”Ÿå‘½å‘¨æœŸè¯¦è§£

```typescript
export interface BootstrapExecutorPlugin {
  readonly pluginName: string;

  /**
   * onBefore: åœ¨åˆå§‹åŒ–å‰æ‰§è¡Œ
   *
   * é€‚ç”¨åœºæ™¯ï¼š
   * - é…ç½® API å®¢æˆ·ç«¯
   * - åŠ è½½èµ„æºï¼ˆç¿»è¯‘ã€ä¸»é¢˜ç­‰ï¼‰
   * - æ£€æŸ¥ç”¨æˆ·è®¤è¯
   * - åˆå§‹åŒ–ç¬¬ä¸‰æ–¹åº“
   */
  onBefore?(context: BootstrapContext): void | Promise<void>;

  /**
   * onExecute: åœ¨åˆå§‹åŒ–æ—¶æ‰§è¡Œ
   *
   * é€‚ç”¨åœºæ™¯ï¼š
   * - æ‰§è¡Œä¸»è¦ä¸šåŠ¡é€»è¾‘
   * - å¯åŠ¨åå°ä»»åŠ¡
   */
  onExecute?(context: BootstrapContext): void | Promise<void>;

  /**
   * onAfter: åœ¨åˆå§‹åŒ–åæ‰§è¡Œ
   *
   * é€‚ç”¨åœºæ™¯ï¼š
   * - æ¸…ç†ä¸´æ—¶èµ„æº
   * - è®°å½•å¯åŠ¨æ—¥å¿—
   * - å‘é€ç»Ÿè®¡æ•°æ®
   */
  onAfter?(context: BootstrapContext): void | Promise<void>;

  /**
   * onError: é”™è¯¯å¤„ç†
   *
   * é€‚ç”¨åœºæ™¯ï¼š
   * - æ•è·æ’ä»¶é”™è¯¯
   * - é”™è¯¯æ—¥å¿—è®°å½•
   * - é”™è¯¯æ¢å¤
   */
  onError?(error: Error, context: BootstrapContext): void | Promise<void>;
}
```

---

## ğŸ¯ å®æˆ˜ç¤ºä¾‹

### ç¤ºä¾‹ 1ï¼šå›½é™…åŒ–æ’ä»¶

```typescript
// src/base/services/I18nService.ts
import i18next from 'i18next';
import { injectable, inject } from 'inversify';
import { IOCIdentifier } from '@config/IOCIdentifier';
import type { AppConfig } from '@/base/cases/AppConfig';

@injectable()
export class I18nService implements ExecutorPlugin {
  readonly pluginName = 'I18nService';

  constructor(@inject(IOCIdentifier.AppConfig) private config: AppConfig) {}

  async onBefore(): Promise<void> {
    // åŠ è½½ç¿»è¯‘èµ„æº
    const resources = this.loadAllResources();

    // åˆå§‹åŒ– i18next
    await i18next.init({
      lng: this.config.defaultLanguage || 'zh',
      fallbackLng: 'en',
      resources,
      interpolation: {
        escapeValue: false
      }
    });

    console.log('âœ… I18n initialized:', i18next.language);
  }

  private loadAllResources() {
    // ä»é…ç½®æ–‡ä»¶åŠ è½½æ‰€æœ‰ç¿»è¯‘èµ„æº
    return {
      zh: {
        translation: require('@config/i18n/zh').default
      },
      en: {
        translation: require('@config/i18n/en').default
      }
    };
  }

  t(key: string, options?: any): string {
    return i18next.t(key, options);
  }
}
```

### ç¤ºä¾‹ 2ï¼šAPI é…ç½®æ’ä»¶

```typescript
// src/base/apis/feApi/FeApiBootstrap.ts
export class FeApiBootstarp implements BootstrapExecutorPlugin {
  readonly pluginName = 'FeApiBootstarp';

  onBefore({ parameters: { ioc } }: BootstrapContext): void {
    const feApi = ioc.get<FeApi>(FeApi);
    const appConfig = ioc.get<AppConfig>(IOCIdentifier.AppConfig);

    // 1. é…ç½®åŸºç¡€ URL
    feApi.setBaseURL(appConfig.apiBaseUrl);

    // 2. æ·»åŠ è®¤è¯æ’ä»¶
    feApi.usePlugin(
      new AuthTokenPlugin({
        getToken: () => {
          const storage = ioc.get(IOCIdentifier.LocalStorageEncrypt);
          return storage.getItem('token');
        }
      })
    );

    // 3. æ·»åŠ é”™è¯¯å¤„ç†æ’ä»¶
    feApi.usePlugin(
      new ErrorHandlerPlugin({
        onError: (error) => {
          if (error.status === 401) {
            // æœªæˆæƒï¼Œè·³è½¬ç™»å½•
            const router = ioc.get(IOCIdentifier.RouteServiceInterface);
            router.push('/login');
          }
        }
      })
    );

    // 4. æ·»åŠ è¯·æ±‚æ—¥å¿—æ’ä»¶ï¼ˆå¼€å‘ç¯å¢ƒï¼‰
    if (!appConfig.isProduction) {
      feApi.usePlugin(new RequestLoggerPlugin());
    }
  }
}
```

### ç¤ºä¾‹ 3ï¼šç”¨æˆ·è®¤è¯æ’ä»¶

```typescript
// src/base/services/UserService.ts
@injectable()
export class UserService
  extends UserAuthService<UserInfo>
  implements ExecutorPlugin
{
  readonly pluginName = 'UserService';

  constructor(
    @inject(IOCIdentifier.RouteServiceInterface)
    protected routerService: RouteServiceInterface,
    @inject(UserApi) userApi: UserAuthApiInterface<UserInfo>,
    @inject(IOCIdentifier.AppConfig) appConfig: AppConfig,
    @inject(IOCIdentifier.LocalStorageEncrypt) storage: SyncStorageInterface
  ) {
    super(userApi, {
      userStorage: {
        key: appConfig.userInfoStorageKey,
        storage: storage
      },
      credentialStorage: {
        key: appConfig.userTokenStorageKey,
        storage: storage
      }
    });
  }

  /**
   * åœ¨åº”ç”¨å¯åŠ¨æ—¶è‡ªåŠ¨æ¢å¤ç”¨æˆ·ç™»å½•çŠ¶æ€
   */
  async onBefore(): Promise<void> {
    try {
      // æ£€æŸ¥æ˜¯å¦åœ¨ç™»å½•é¡µ
      if (this.routerService.isLoginPage()) {
        return;
      }

      // å¦‚æœå·²ç»æœ‰ç”¨æˆ·ä¿¡æ¯ï¼Œç›´æ¥è¿”å›
      if (this.isAuthenticated()) {
        console.log('âœ… User already authenticated');
        return;
      }

      // å°è¯•ä»å­˜å‚¨ä¸­æ¢å¤ token
      const token = this.getToken();
      if (!token) {
        // æ²¡æœ‰ tokenï¼Œè·³è½¬ç™»å½•
        throw new AppError('NO_USER_TOKEN');
      }

      // ä½¿ç”¨ token è·å–ç”¨æˆ·ä¿¡æ¯
      const userInfo = await this.userInfo();
      console.log('âœ… User authenticated:', userInfo.name);
    } catch (error) {
      // è®¤è¯å¤±è´¥ï¼Œæ¸…ç†å­˜å‚¨å¹¶è·³è½¬ç™»å½•
      this.clearAuth();
      this.routerService.push('/login');
      console.log('âŒ User authentication failed, redirecting to login');
    }
  }

  getToken(): string | null {
    return this.credential();
  }

  private clearAuth() {
    this.setCredential(null);
    this.setUser(null);
  }
}
```

### ç¤ºä¾‹ 4ï¼šå¼€å‘å·¥å…·æ’ä»¶

```typescript
// src/core/bootstraps/PrintBootstrap.ts
export const printBootstrap: BootstrapExecutorPlugin = {
  pluginName: 'PrintBootstrap',

  onAfter({ parameters: { logger, ioc } }: BootstrapContext): void {
    const appConfig = ioc.get<AppConfig>(IOCIdentifier.AppConfig);

    // æ‰“å°åº”ç”¨ä¿¡æ¯
    logger.info('ğŸš€ Application started successfully!');
    logger.info('ğŸ“¦ App Name:', appConfig.appName);
    logger.info('ğŸŒ Environment:', appConfig.env);
    logger.info('ğŸ”— API Base URL:', appConfig.apiBaseUrl);

    // æ‰“å°å·²æ³¨å†Œçš„æœåŠ¡
    logger.info('ğŸ“‹ Registered Services:');
    logger.info('  - UserService');
    logger.info('  - I18nService');
    logger.info('  - RouteService');

    // æ‰“å°è­¦å‘Šï¼ˆå¦‚æœæœ‰ï¼‰
    if (!appConfig.isProduction && appConfig.mockEnabled) {
      logger.warn('âš ï¸ Mock API is enabled');
    }
  }
};
```

---

## ğŸ§ª æµ‹è¯•ï¼šBootstrap çš„æ ¸å¿ƒä¼˜åŠ¿

### ä¸ºä»€ä¹ˆæµ‹è¯•å¦‚æ­¤é‡è¦ï¼Ÿ

Bootstrap æ¶æ„çš„ä¸€ä¸ª**æœ€é‡è¦çš„ä¼˜åŠ¿**å°±æ˜¯**å¯æµ‹è¯•æ€§**ã€‚é€šè¿‡åˆ†ç¦»åˆå§‹åŒ–é€»è¾‘å’Œ UIï¼Œæˆ‘ä»¬å¯ä»¥ï¼š

- âœ… ç‹¬ç«‹æµ‹è¯•æ¯ä¸ªæ’ä»¶
- âœ… è½»æ¾ mock ä¾èµ–
- âœ… å¿«é€Ÿè¿è¡Œæµ‹è¯•ï¼ˆä¸éœ€è¦æ¸²æŸ“ UIï¼‰
- âœ… æé«˜æµ‹è¯•è¦†ç›–ç‡

### ä¼ ç»Ÿæ–¹å¼ vs Bootstrap æ–¹å¼

#### âŒ ä¼ ç»Ÿæ–¹å¼ï¼šç»„ä»¶ä¸­æ··æ‚åˆå§‹åŒ–é€»è¾‘

```typescript
// âŒ ä¼ ç»Ÿç»„ä»¶ï¼šéš¾ä»¥æµ‹è¯•
function App() {
  const [loading, setLoading] = useState(true);
  const [user, setUser] = useState(null);
  const [i18nReady, setI18nReady] = useState(false);
  const [error, setError] = useState(null);

  useEffect(() => {
    const init = async () => {
      try {
        // 1. åˆå§‹åŒ–å›½é™…åŒ–
        await i18next.init({
          lng: 'zh',
          resources: { /* ... */ }
        });
        setI18nReady(true);

        // 2. é…ç½® API
        api.setBaseURL('https://api.example.com');
        api.usePlugin(new AuthPlugin());

        // 3. æ£€æŸ¥ç”¨æˆ·è®¤è¯
        const token = localStorage.getItem('token');
        if (token) {
          const userInfo = await fetch('/api/user', {
            headers: { Authorization: `Bearer ${token}` }
          }).then(res => res.json());
          setUser(userInfo);
        }
      } catch (err) {
        setError(err);
      } finally {
        setLoading(false);
      }
    };

    init();
  }, []);

  if (loading) return <div>Loading...</div>;
  if (error) return <div>Error: {error.message}</div>;

  return <Router />;
}
```

**æµ‹è¯•ä»£ç ï¼ˆä¼ ç»Ÿæ–¹å¼ï¼‰ï¼šğŸ˜°ğŸ˜°ğŸ˜° éå¸¸å›°éš¾**

```typescript
// âŒ ä¼ ç»Ÿæ–¹å¼çš„æµ‹è¯•ï¼šå……æ»¡æŠ€å·§å’Œ hack
import { describe, it, expect, vi, beforeEach } from 'vitest';
import { render, screen, waitFor } from '@testing-library/react';
import App from './App';

describe('App (Traditional)', () => {
  beforeEach(() => {
    // ğŸ˜° éœ€è¦ mock å…¨å±€å˜é‡
    global.localStorage = {
      getItem: vi.fn(),
      setItem: vi.fn(),
      removeItem: vi.fn(),
      clear: vi.fn()
    };

    // ğŸ˜° éœ€è¦ mock fetch
    global.fetch = vi.fn();

    // ğŸ˜° éœ€è¦ mock i18next
    vi.mock('i18next', () => ({
      init: vi.fn().mockResolvedValue(undefined),
      t: vi.fn(key => key)
    }));
  });

  it('should initialize and load user', async () => {
    // ğŸ˜° è®¾ç½®å¤æ‚çš„ mock
    vi.mocked(localStorage.getItem).mockReturnValue('mock-token');
    vi.mocked(fetch).mockResolvedValueOnce({
      ok: true,
      json: async () => ({ id: '1', name: 'John' })
    });

    render(<App />);

    // ğŸ˜° éœ€è¦ç­‰å¾…å¤šä¸ªå¼‚æ­¥æ“ä½œ
    await waitFor(() => {
      expect(screen.queryByText('Loading...')).not.toBeInTheDocument();
    }, { timeout: 3000 });

    // ğŸ˜° éš¾ä»¥éªŒè¯ä¸­é—´çŠ¶æ€
    expect(fetch).toHaveBeenCalledWith('/api/user', expect.any(Object));
  });

  it('should handle error', async () => {
    // ğŸ˜° æ¯ä¸ªæµ‹è¯•éƒ½éœ€è¦é‡æ–°è®¾ç½® mock
    vi.mocked(fetch).mockRejectedValueOnce(new Error('Network error'));

    render(<App />);

    await waitFor(() => {
      expect(screen.getByText(/Error/)).toBeInTheDocument();
    });
  });

  // ğŸ˜° é—®é¢˜ï¼š
  // 1. éœ€è¦ mock å¤§é‡å…¨å±€å˜é‡ï¼ˆlocalStorage, fetch, i18nextï¼‰
  // 2. æµ‹è¯•è¿è¡Œæ…¢ï¼ˆéœ€è¦æ¸²æŸ“ç»„ä»¶ï¼‰
  // 3. éš¾ä»¥æµ‹è¯•é”™è¯¯åœºæ™¯
  // 4. æµ‹è¯•ä¹‹é—´å¯èƒ½äº’ç›¸å¹²æ‰°
  // 5. éš¾ä»¥æµ‹è¯•åˆå§‹åŒ–çš„å„ä¸ªæ­¥éª¤
});
```

#### âœ… Bootstrap æ–¹å¼ï¼šç‹¬ç«‹æµ‹è¯•æ’ä»¶

```typescript
// âœ… Bootstrap æ–¹å¼ï¼šé€»è¾‘å’Œ UI åˆ†ç¦»
// 1. æ’ä»¶å®ç°
@injectable()
export class UserService implements ExecutorPlugin {
  readonly pluginName = 'UserService';

  constructor(
    @inject(UserApi) private api: UserApi,
    @inject(IOCIdentifier.LocalStorageEncrypt) private storage: Storage,
    @inject(IOCIdentifier.RouteServiceInterface) private router: RouteService
  ) {}

  async onBefore(): Promise<void> {
    const token = this.storage.getItem('token');
    if (!token) {
      throw new AppError('NO_USER_TOKEN');
    }

    const userInfo = await this.api.getUserInfo(token);
    this.setUser(userInfo);
  }
}

// 2. UI ç»„ä»¶å˜å¾—ç®€å•
function App() {
  return (
    <BootstrapsProvider>
      <ComboProvider themeConfig={themeConfig}>
        <AppRouterProvider pages={allPages} />
      </ComboProvider>
    </BootstrapsProvider>
  );
}
```

**æµ‹è¯•ä»£ç ï¼ˆBootstrap æ–¹å¼ï¼‰ï¼šğŸ˜ŠğŸ˜ŠğŸ˜Š éå¸¸ç®€å•**

```typescript
// âœ… Bootstrap æ–¹å¼çš„æµ‹è¯•ï¼šæ¸…æ™°ã€ç®€å•ã€å¿«é€Ÿ
import { describe, it, expect, vi, beforeEach } from 'vitest';
import { UserService } from '@/base/services/UserService';
import { AppError } from '@/base/cases/AppError';

describe('UserService Plugin', () => {
  let userService: UserService;
  let mockApi: any;
  let mockStorage: any;
  let mockRouter: any;

  beforeEach(() => {
    // âœ… åªéœ€è¦ mock ä¾èµ–æ¥å£ï¼Œä¸éœ€è¦ mock å…¨å±€å˜é‡
    mockApi = {
      getUserInfo: vi.fn()
    };

    mockStorage = {
      getItem: vi.fn(),
      setItem: vi.fn()
    };

    mockRouter = {
      push: vi.fn()
    };

    // âœ… åˆ›å»ºæœåŠ¡å®ä¾‹
    userService = new UserService(mockApi, mockStorage, mockRouter);
  });

  it('should load user when token exists', async () => {
    // âœ… è®¾ç½®æµ‹è¯•æ•°æ®
    mockStorage.getItem.mockReturnValue('mock-token');
    mockApi.getUserInfo.mockResolvedValue({
      id: '1',
      name: 'John Doe'
    });

    // âœ… æ‰§è¡Œæ’ä»¶ç”Ÿå‘½å‘¨æœŸ
    await userService.onBefore();

    // âœ… æ¸…æ™°çš„æ–­è¨€
    expect(mockStorage.getItem).toHaveBeenCalledWith('token');
    expect(mockApi.getUserInfo).toHaveBeenCalledWith('mock-token');
    expect(userService.getUser()).toEqual({
      id: '1',
      name: 'John Doe'
    });
  });

  it('should throw error when token is missing', async () => {
    // âœ… è½»æ¾æµ‹è¯•é”™è¯¯åœºæ™¯
    mockStorage.getItem.mockReturnValue(null);

    // âœ… éªŒè¯é”™è¯¯
    await expect(userService.onBefore()).rejects.toThrow(AppError);
    await expect(userService.onBefore()).rejects.toThrow('NO_USER_TOKEN');
  });

  it('should handle API error', async () => {
    // âœ… è½»æ¾æ¨¡æ‹Ÿ API é”™è¯¯
    mockStorage.getItem.mockReturnValue('mock-token');
    mockApi.getUserInfo.mockRejectedValue(new Error('Network error'));

    // âœ… éªŒè¯é”™è¯¯å¤„ç†
    await expect(userService.onBefore()).rejects.toThrow('Network error');
  });

  // âœ… ä¼˜åŠ¿ï¼š
  // 1. ä¸éœ€è¦ mock å…¨å±€å˜é‡
  // 2. æµ‹è¯•è¿è¡Œå¿«ï¼ˆä¸éœ€è¦æ¸²æŸ“ UIï¼‰
  // 3. æ˜“äºæµ‹è¯•é”™è¯¯åœºæ™¯
  // 4. æµ‹è¯•ä¹‹é—´å®Œå…¨ç‹¬ç«‹
  // 5. å¯ä»¥å•ç‹¬æµ‹è¯•æ¯ä¸ªåˆå§‹åŒ–æ­¥éª¤
});
```

### æµ‹è¯•å¤æ‚åº¦å¯¹æ¯”

| æµ‹è¯•åœºæ™¯         | ä¼ ç»Ÿæ–¹å¼                                     | Bootstrap æ–¹å¼                  | æå‡      |
| ---------------- | -------------------------------------------- | ------------------------------- | --------- |
| **Mock å¤æ‚åº¦**  | ğŸ˜°ğŸ˜°ğŸ˜° éœ€è¦ mock å…¨å±€å˜é‡ã€fetchã€i18next ç­‰ | ğŸ˜Š åªéœ€ mock ä¾èµ–æ¥å£           | **80%**   |
| **æµ‹è¯•è¿è¡Œé€Ÿåº¦** | ğŸ˜°ğŸ˜° æ…¢ï¼ˆéœ€è¦æ¸²æŸ“ç»„ä»¶ï¼Œç­‰å¾…å¼‚æ­¥ï¼‰            | ğŸ˜ŠğŸ˜ŠğŸ˜Š å¿«ï¼ˆçº¯é€»è¾‘æµ‹è¯•ï¼‰         | **5-10x** |
| **æµ‹è¯•é”™è¯¯åœºæ™¯** | ğŸ˜°ğŸ˜°ğŸ˜° å›°éš¾ï¼ˆéœ€è¦å¤æ‚çš„ mock è®¾ç½®ï¼‰          | ğŸ˜ŠğŸ˜ŠğŸ˜Š ç®€å•ï¼ˆç›´æ¥ mock rejectï¼‰ | **90%**   |
| **æµ‹è¯•éš”ç¦»æ€§**   | ğŸ˜°ğŸ˜° å·®ï¼ˆå…¨å±€å˜é‡å¯èƒ½äº’ç›¸å½±å“ï¼‰              | ğŸ˜ŠğŸ˜ŠğŸ˜Š å¥½ï¼ˆæ¯ä¸ªæµ‹è¯•ç‹¬ç«‹ï¼‰       | **100%**  |
| **æµ‹è¯•å¯è¯»æ€§**   | ğŸ˜°ğŸ˜° å·®ï¼ˆå……æ»¡ mock å’Œ hackï¼‰                 | ğŸ˜ŠğŸ˜ŠğŸ˜Š å¥½ï¼ˆæ¸…æ™°çš„è¾“å…¥è¾“å‡ºï¼‰     | **80%**   |
| **è¦†ç›–ç‡**       | ğŸ˜°ğŸ˜° ä½ï¼ˆéš¾ä»¥è¦†ç›–æ‰€æœ‰åˆ†æ”¯ï¼‰                  | ğŸ˜ŠğŸ˜ŠğŸ˜Š é«˜ï¼ˆæ˜“äºè¦†ç›–æ‰€æœ‰åœºæ™¯ï¼‰   | **50%**   |

### å®é™…é¡¹ç›®ä¸­çš„æµ‹è¯•ç¤ºä¾‹

#### ç¤ºä¾‹ 1ï¼šæµ‹è¯• I18n æ’ä»¶

```typescript
// src/base/services/I18nService.test.ts
import { describe, it, expect, beforeEach, vi, afterEach } from 'vitest';
import { I18nService } from '@/base/services/I18nService';
import i18n from 'i18next';

// Mock i18next
vi.mock('i18next', () => ({
  default: {
    use: vi.fn().mockReturnThis(),
    init: vi.fn(),
    t: vi.fn(),
    changeLanguage: vi.fn(),
    language: 'en',
    services: {
      languageDetector: {
        addDetector: vi.fn()
      }
    }
  }
}));

describe('I18nService', () => {
  let service: I18nService;

  beforeEach(() => {
    service = new I18nService('/en/test/path');
    vi.clearAllMocks();
  });

  describe('onBefore', () => {
    it('should initialize i18n with correct configuration', () => {
      // âœ… æ‰§è¡Œæ’ä»¶ç”Ÿå‘½å‘¨æœŸ
      service.onBefore();

      // âœ… éªŒè¯åˆå§‹åŒ–é…ç½®
      expect(i18n.use).toHaveBeenCalledTimes(3);
      expect(i18n.init).toHaveBeenCalledWith(
        expect.objectContaining({
          debug: false,
          detection: {
            order: ['pathLanguageDetector', 'navigator', 'localStorage'],
            caches: []
          }
        })
      );
    });

    it('should detect language from path correctly', () => {
      service.onBefore();

      const detector = vi.mocked(i18n.services.languageDetector.addDetector)
        .mock.calls[0][0];

      // âœ… æµ‹è¯•è¯­è¨€æ£€æµ‹é€»è¾‘
      const language = detector.lookup();
      expect(language).toBe('en');
    });

    it('should return fallback language for invalid path', () => {
      const invalidService = new I18nService('/invalid/path');
      invalidService.onBefore();

      const detector = vi.mocked(i18n.services.languageDetector.addDetector)
        .mock.calls[0][0];

      // âœ… æµ‹è¯•è¾¹ç•Œæƒ…å†µ
      const language = detector.lookup();
      expect(language).toBe('zh'); // fallback language
    });
  });

  describe('changeLanguage', () => {
    it('should change language using i18n', async () => {
      await service.changeLanguage('en');
      expect(i18n.changeLanguage).toHaveBeenCalledWith('en');
    });

    it('should handle language change error', async () => {
      // âœ… æµ‹è¯•é”™è¯¯åœºæ™¯
      vi.mocked(i18n.changeLanguage).mockRejectedValueOnce(
        new Error('Change failed')
      );

      await expect(service.changeLanguage('en')).rejects.toThrow(
        'Change failed'
      );
    });
  });
});
```

#### ç¤ºä¾‹ 2ï¼šæµ‹è¯• Bootstrap å¯åŠ¨æµç¨‹

```typescript
// __tests__/src/core/bootstraps/BootstrapsApp.test.ts
import { describe, it, expect, beforeEach, vi } from 'vitest';
import { BootstrapClient } from '@/core/bootstraps/BootstrapClient';
import type { BootstrapClientArgs } from '@/core/bootstraps/BootstrapClient';
import { InversifyContainer } from '@/base/cases/InversifyContainer';
import { createIOCFunction } from '@qlover/corekit-bridge';
import { browserGlobalsName } from '@config/common';

// Mock ä¾èµ–
vi.mock('@/core/registers/IocRegisterImpl', () => ({
  IocRegisterImpl: vi.fn().mockImplementation(() => ({
    getRegisterList: vi.fn().mockReturnValue([]),
    register: vi.fn()
  }))
}));

vi.mock('@/core/bootstraps/BootstrapsRegistry', () => ({
  BootstrapsRegistry: vi.fn().mockImplementation(() => ({
    register: vi.fn().mockReturnValue([])
  }))
}));

describe('BootstrapClient', () => {
  let mockArgs: BootstrapClientArgs;
  let mockIOC: ReturnType<typeof createIOCFunction>;

  beforeEach(() => {
    vi.clearAllMocks();

    const container = new InversifyContainer();
    mockIOC = createIOCFunction(container);

    mockArgs = {
      root: {},
      bootHref: 'http://localhost:3000',
      ioc: {
        create: vi.fn().mockReturnValue(mockIOC)
      }
    };
  });

  describe('main', () => {
    it('should initialize bootstrap successfully', async () => {
      // âœ… æ‰§è¡Œå¯åŠ¨æµç¨‹
      const result = await BootstrapClient.main(mockArgs);

      // âœ… éªŒè¯å¯åŠ¨ç»“æœ
      expect(result.bootHref).toBe('http://localhost:3000');

      // âœ… éªŒè¯å…¨å±€å˜é‡æ³¨å…¥
      expect(
        (mockArgs.root as Record<string, unknown>)[browserGlobalsName]
      ).toBeDefined();

      const injectedGlobals = (mockArgs.root as Record<string, unknown>)[
        browserGlobalsName
      ] as Record<string, unknown>;

      expect(injectedGlobals).toHaveProperty('logger');
      expect(injectedGlobals).toHaveProperty('appConfig');
    });

    it('should handle initialization error', async () => {
      // âœ… æµ‹è¯•é”™è¯¯åœºæ™¯
      mockArgs.ioc.create = vi.fn().mockImplementation(() => {
        throw new Error('IOC creation failed');
      });

      // âœ… éªŒè¯é”™è¯¯ä¸ä¼šå¯¼è‡´åº”ç”¨å´©æºƒ
      await expect(BootstrapClient.main(mockArgs)).rejects.toThrow(
        'IOC creation failed'
      );
    });
  });
});
```

#### ç¤ºä¾‹ 3ï¼šæµ‹è¯• API é…ç½®æ’ä»¶

```typescript
// __tests__/src/base/apis/UserApiBootstrap.test.ts
import { describe, it, expect, vi, beforeEach } from 'vitest';
import { UserApiBootstarp } from '@/base/apis/userApi/UserApiBootstarp';

describe('UserApiBootstrap', () => {
  let plugin: UserApiBootstarp;
  let mockContext: any;
  let mockUserApi: any;

  beforeEach(() => {
    plugin = new UserApiBootstarp();

    // âœ… åˆ›å»º mock ä¸Šä¸‹æ–‡
    mockUserApi = {
      usePlugin: vi.fn()
    };

    mockContext = {
      parameters: {
        ioc: {
          get: vi.fn().mockReturnValue(mockUserApi)
        }
      }
    };
  });

  it('should have correct plugin name', () => {
    expect(plugin.pluginName).toBe('UserApiBootstarp');
  });

  it('should configure API plugins in onBefore', () => {
    // âœ… æ‰§è¡Œæ’ä»¶ç”Ÿå‘½å‘¨æœŸ
    plugin.onBefore(mockContext);

    // âœ… éªŒè¯ API é…ç½®
    expect(mockContext.parameters.ioc.get).toHaveBeenCalled();
    expect(mockUserApi.usePlugin).toHaveBeenCalled();
  });

  it('should add multiple plugins to API', () => {
    plugin.onBefore(mockContext);

    // âœ… éªŒè¯æ·»åŠ äº†å¤šä¸ªæ’ä»¶
    expect(mockUserApi.usePlugin).toHaveBeenCalledTimes(3);
  });
});
```

### æµ‹è¯•æœ€ä½³å®è·µ

#### 1. âœ… ä½¿ç”¨ Vitest çš„æµ‹è¯•å·¥å…·

```typescript
import { describe, it, expect, vi, beforeEach, afterEach } from 'vitest';

describe('MyPlugin', () => {
  beforeEach(() => {
    // âœ… æ¯ä¸ªæµ‹è¯•å‰é‡ç½® mock
    vi.clearAllMocks();
  });

  afterEach(() => {
    // âœ… æ¸…ç†èµ„æº
    vi.restoreAllMocks();
  });

  it('should do something', () => {
    // æµ‹è¯•é€»è¾‘
  });
});
```

#### 2. âœ… æµ‹è¯•æ’ä»¶çš„ç”Ÿå‘½å‘¨æœŸ

```typescript
describe('UserService Plugin', () => {
  it('should execute onBefore lifecycle', async () => {
    const service = new UserService(mockApi, mockStorage, mockRouter);

    // âœ… æµ‹è¯• onBefore
    await service.onBefore();

    expect(mockApi.getUserInfo).toHaveBeenCalled();
  });

  it('should execute onAfter lifecycle', async () => {
    const service = new UserService(mockApi, mockStorage, mockRouter);

    // âœ… æµ‹è¯• onAfter
    await service.onAfter?.();

    // éªŒè¯æ¸…ç†é€»è¾‘
  });

  it('should handle onError lifecycle', async () => {
    const service = new UserService(mockApi, mockStorage, mockRouter);
    const error = new Error('Test error');

    // âœ… æµ‹è¯• onError
    await service.onError?.(error, mockContext);

    // éªŒè¯é”™è¯¯å¤„ç†
  });
});
```

#### 3. âœ… æµ‹è¯•è¾¹ç•Œæƒ…å†µå’Œé”™è¯¯åœºæ™¯

```typescript
describe('UserService Error Handling', () => {
  it('should handle missing token', async () => {
    mockStorage.getItem.mockReturnValue(null);

    // âœ… éªŒè¯é”™è¯¯
    await expect(service.onBefore()).rejects.toThrow('NO_USER_TOKEN');
  });

  it('should handle network error', async () => {
    mockStorage.getItem.mockReturnValue('token');
    mockApi.getUserInfo.mockRejectedValue(new Error('Network error'));

    // âœ… éªŒè¯é”™è¯¯å¤„ç†
    await expect(service.onBefore()).rejects.toThrow('Network error');
  });

  it('should handle invalid token', async () => {
    mockStorage.getItem.mockReturnValue('invalid-token');
    mockApi.getUserInfo.mockRejectedValue(new Error('401 Unauthorized'));

    // âœ… éªŒè¯ 401 é”™è¯¯å¤„ç†
    await expect(service.onBefore()).rejects.toThrow('401 Unauthorized');
  });
});
```

#### 4. âœ… æµ‹è¯•æ’ä»¶ä¹‹é—´çš„ä¾èµ–

```typescript
describe('Plugin Dependencies', () => {
  it('should ensure I18n is initialized before UserService', async () => {
    const i18nService = new I18nService('/en/path');
    const userService = new UserService(mockApi, mockStorage, mockRouter);

    // âœ… I18n å…ˆåˆå§‹åŒ–
    await i18nService.onBefore();

    // âœ… ç„¶ååˆå§‹åŒ– UserService
    await userService.onBefore();

    // âœ… éªŒè¯ UserService å¯ä»¥ä½¿ç”¨ç¿»è¯‘
    expect(i18n.t('some.key')).toBeDefined();
  });
});
```

### è¿è¡Œæµ‹è¯•

```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
npm run test

# è¿è¡Œæµ‹è¯•å¹¶ç›‘å¬æ–‡ä»¶å˜åŒ–
npm run test -- --watch

# è¿è¡Œç‰¹å®šæ–‡ä»¶çš„æµ‹è¯•
npm run test -- UserService.test.ts

# ç”Ÿæˆæµ‹è¯•è¦†ç›–ç‡æŠ¥å‘Š
npm run test -- --coverage
```

### æµ‹è¯•è¦†ç›–ç‡ç›®æ ‡

åœ¨ Bootstrap æ¶æ„ä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥è½»æ¾è¾¾åˆ°é«˜è¦†ç›–ç‡ï¼š

- **æ’ä»¶é€»è¾‘**ï¼š> 90% è¦†ç›–ç‡
- **æœåŠ¡å±‚**ï¼š> 85% è¦†ç›–ç‡
- **API é€‚é…å™¨**ï¼š> 80% è¦†ç›–ç‡
- **æ•´ä½“åº”ç”¨**ï¼š> 75% è¦†ç›–ç‡

### æ€»ç»“ï¼šæµ‹è¯•çš„ä»·å€¼

Bootstrap æ¶æ„é€šè¿‡åˆ†ç¦»å…³æ³¨ç‚¹ï¼Œè®©æµ‹è¯•å˜å¾—ï¼š

1. **æ›´ç®€å•** - ä¸éœ€è¦ mock å…¨å±€å˜é‡å’Œå¤æ‚çš„ç¯å¢ƒ
2. **æ›´å¿«é€Ÿ** - çº¯é€»è¾‘æµ‹è¯•ï¼Œä¸éœ€è¦æ¸²æŸ“ UI
3. **æ›´å¯é ** - æµ‹è¯•ä¹‹é—´å®Œå…¨ç‹¬ç«‹ï¼Œä¸ä¼šäº’ç›¸å¹²æ‰°
4. **æ›´å…¨é¢** - æ˜“äºæµ‹è¯•æ‰€æœ‰è¾¹ç•Œæƒ…å†µå’Œé”™è¯¯åœºæ™¯
5. **æ›´æœ‰ä¿¡å¿ƒ** - é«˜è¦†ç›–ç‡ä¿è¯ä»£ç è´¨é‡

> ğŸ’¡ **é‡è¦æç¤º**ï¼šå¯æµ‹è¯•æ€§æ˜¯ Bootstrap æ¶æ„æœ€å¤§çš„ä¼˜åŠ¿ä¹‹ä¸€ã€‚å¦‚æœä½ å‘ç°æŸä¸ªæ’ä»¶éš¾ä»¥æµ‹è¯•ï¼Œå¾ˆå¯èƒ½æ˜¯è®¾è®¡æœ‰é—®é¢˜ï¼Œéœ€è¦é‡æ–°è€ƒè™‘èŒè´£åˆ’åˆ†ã€‚

---

## ğŸ’ æœ€ä½³å®è·µ

### 1. æ’ä»¶è®¾è®¡åŸåˆ™

#### âœ… å•ä¸€èŒè´£

```typescript
// âœ… å¥½çš„æ’ä»¶è®¾è®¡ï¼šåªåšä¸€ä»¶äº‹
export class ApiConfigPlugin implements BootstrapExecutorPlugin {
  readonly pluginName = 'ApiConfigPlugin';

  onBefore({ parameters: { ioc } }: BootstrapContext): void {
    // åªè´Ÿè´£é…ç½® API
    const api = ioc.get<FeApi>(FeApi);
    api.setBaseURL(config.apiBaseUrl);
    api.usePlugin(new AuthPlugin());
  }
}

// âŒ ä¸å¥½çš„æ’ä»¶è®¾è®¡ï¼šåšäº†å¤ªå¤šäº‹
export class BadPlugin implements BootstrapExecutorPlugin {
  readonly pluginName = 'BadPlugin';

  onBefore({ parameters: { ioc } }: BootstrapContext): void {
    // é…ç½® API
    const api = ioc.get<FeApi>(FeApi);
    api.setBaseURL(config.apiBaseUrl);

    // åˆå§‹åŒ–å›½é™…åŒ–
    i18next.init({
      /* ... */
    });

    // æ£€æŸ¥ç”¨æˆ·è®¤è¯
    checkAuth();

    // é…ç½®è·¯ç”±
    configureRouter();

    // å¤ªå¤šèŒè´£ï¼âŒ
  }
}
```

#### âœ… æ˜ç¡®ä¾èµ–

```typescript
// âœ… é€šè¿‡æ„é€ å‡½æ•°æ³¨å…¥ä¾èµ–
@injectable()
export class UserService implements ExecutorPlugin {
  constructor(
    @inject(UserApi) private api: UserApi,
    @inject(IOCIdentifier.AppConfig) private config: AppConfig
  ) {}
}

// âŒ ç›´æ¥åˆ›å»ºä¾èµ–
export class BadUserService implements ExecutorPlugin {
  private api = new UserApi(); // âŒ ç¡¬ç¼–ç ä¾èµ–
  private config = new AppConfig(); // âŒ éš¾ä»¥æµ‹è¯•
}
```

### 2. é”™è¯¯å¤„ç†

```typescript
export class UserService implements ExecutorPlugin {
  readonly pluginName = 'UserService';

  async onBefore(): Promise<void> {
    try {
      await this.initializeUser();
    } catch (error) {
      // âœ… ä¼˜é›…çš„é”™è¯¯å¤„ç†
      if (error instanceof AppError) {
        // ä¸šåŠ¡é”™è¯¯
        this.handleBusinessError(error);
      } else if (error instanceof NetworkError) {
        // ç½‘ç»œé”™è¯¯
        this.handleNetworkError(error);
      } else {
        // æœªçŸ¥é”™è¯¯
        this.logger.error('Unknown error:', error);
      }

      // ä¸è¦è®©é”™è¯¯ä¼ æ’­ï¼Œå¯¼è‡´åº”ç”¨å´©æºƒ
      // è€Œæ˜¯è¿›è¡Œé€‚å½“çš„é™çº§å¤„ç†
    }
  }

  private handleBusinessError(error: AppError) {
    if (error.code === 'NO_USER_TOKEN') {
      // è·³è½¬ç™»å½•é¡µ
      this.router.push('/login');
    } else if (error.code === 'TOKEN_EXPIRED') {
      // åˆ·æ–° token
      this.refreshToken();
    }
  }
}
```

### 3. æ€§èƒ½ä¼˜åŒ–

```typescript
// âœ… æŒ‰éœ€åŠ è½½æ’ä»¶
export class BootstrapsRegistry {
  register(): BootstrapExecutorPlugin[] {
    const plugins: BootstrapExecutorPlugin[] = [
      // å¿…éœ€æ’ä»¶
      IOC(IOCIdentifier.I18nServiceInterface),
      new UserApiBootstarp()
    ];

    // å¼€å‘ç¯å¢ƒæ’ä»¶
    if (!this.appConfig.isProduction) {
      plugins.push(new DevToolsPlugin(), new MockDataPlugin());
    }

    // åŠŸèƒ½å¼€å…³æ’ä»¶
    if (this.appConfig.features.analytics) {
      plugins.push(new AnalyticsPlugin());
    }

    return plugins;
  }
}
```

### 4. æ—¥å¿—è®°å½•

```typescript
export class ApiConfigPlugin implements BootstrapExecutorPlugin {
  readonly pluginName = 'ApiConfigPlugin';

  async onBefore({ parameters: { logger } }: BootstrapContext): Promise<void> {
    logger.info(`[${this.pluginName}] Configuring API...`);

    try {
      await this.configureAPI();
      logger.info(`[${this.pluginName}] âœ… API configured successfully`);
    } catch (error) {
      logger.error(`[${this.pluginName}] âŒ API configuration failed:`, error);
      throw error;
    }
  }
}
```

---

## â“ å¸¸è§é—®é¢˜

### Q1: Bootstrap å’Œ React çš„ç”Ÿå‘½å‘¨æœŸæœ‰ä»€ä¹ˆå…³ç³»ï¼Ÿ

**A:** Bootstrap åœ¨ React æ¸²æŸ“ä¹‹å‰æ‰§è¡Œã€‚

```
Bootstrap åˆå§‹åŒ– â†’ Bootstrap å¯åŠ¨ â†’ React æ¸²æŸ“
```

### Q2: æ’ä»¶æ‰§è¡Œé¡ºåºé‡è¦å—ï¼Ÿ

**A:** éå¸¸é‡è¦ï¼æ’ä»¶æŒ‰ç…§æ³¨å†Œé¡ºåºä¾æ¬¡æ‰§è¡Œã€‚

```typescript
// âœ… æ­£ç¡®çš„é¡ºåº
bootstrap.use([
  IOC(I18nService), // 1. å…ˆåˆå§‹åŒ–å›½é™…åŒ–ï¼ˆå…¶ä»–æ’ä»¶å¯èƒ½éœ€è¦ï¼‰
  new ApiConfigPlugin(), // 2. å†é…ç½® API
  IOC(UserService) // 3. æœ€åæ£€æŸ¥ç”¨æˆ·è®¤è¯ï¼ˆä¾èµ– APIï¼‰
]);

// âŒ é”™è¯¯çš„é¡ºåº
bootstrap.use([
  IOC(UserService), // âŒ ç”¨æˆ·æœåŠ¡ä¾èµ– APIï¼Œä½† API è¿˜æ²¡é…ç½®
  new ApiConfigPlugin(), // é…ç½® API
  IOC(I18nService) // å›½é™…åŒ–åœ¨æœ€åï¼ˆå¤ªæ™šäº†ï¼‰
]);
```

### Q3: å¦‚ä½•è°ƒè¯• Bootstrapï¼Ÿ

```typescript
// æ–¹æ³• 1ï¼šä½¿ç”¨æ—¥å¿—
export class MyPlugin implements BootstrapExecutorPlugin {
  readonly pluginName = 'MyPlugin';

  async onBefore({ parameters: { logger } }: BootstrapContext): Promise<void> {
    logger.info(`[${this.pluginName}] Starting...`);
    // ... ä½ çš„é€»è¾‘
    logger.info(`[${this.pluginName}] Completed`);
  }
}

// æ–¹æ³• 2ï¼šä½¿ç”¨è°ƒè¯•æ’ä»¶
export const debugPlugin: BootstrapExecutorPlugin = {
  pluginName: 'DebugPlugin',

  onBefore(context) {
    console.log('onBefore context:', context);
  },

  onAfter(context) {
    console.log('onAfter context:', context);
  }
};
```

### Q4: å¦‚ä½•æµ‹è¯•æ’ä»¶ï¼Ÿ

```typescript
describe('UserService Plugin', () => {
  it('should initialize user on startup', async () => {
    // åˆ›å»º mock ä¾èµ–
    const mockApi = {
      getUserInfo: jest.fn().mockResolvedValue({ name: 'John' })
    };
    const mockStorage = {
      getItem: jest.fn().mockReturnValue('mock-token')
    };

    // åˆ›å»ºæœåŠ¡
    const userService = new UserService(
      mockRouter,
      mockApi,
      mockConfig,
      mockStorage
    );

    // æ‰§è¡Œæ’ä»¶ç”Ÿå‘½å‘¨æœŸ
    await userService.onBefore();

    // éªŒè¯
    expect(mockApi.getUserInfo).toHaveBeenCalledWith('mock-token');
  });
});
```

### Q5: Bootstrap é€‚åˆæ‰€æœ‰é¡¹ç›®å—ï¼Ÿ

**A:** ä¸ä¸€å®šã€‚Bootstrap æ›´é€‚åˆï¼š

âœ… **é€‚åˆä½¿ç”¨çš„åœºæ™¯ï¼š**

- ä¸­å¤§å‹åº”ç”¨
- éœ€è¦å¤æ‚åˆå§‹åŒ–é€»è¾‘
- å¤šç«¯åº”ç”¨ï¼ˆWebã€ç§»åŠ¨ç«¯ã€å°ç¨‹åºï¼‰
- éœ€è¦æ¨¡å—åŒ–å’Œå¯æµ‹è¯•æ€§
- å›¢é˜Ÿåä½œå¼€å‘

âŒ **ä¸é€‚åˆçš„åœºæ™¯ï¼š**

- ç®€å•çš„å±•ç¤ºé¡µé¢
- åŸå‹é¡¹ç›®
- æ²¡æœ‰å¤æ‚åˆå§‹åŒ–é€»è¾‘çš„é¡¹ç›®

### Q6: å¦‚ä½•ä¿è¯æµ‹è¯•è¦†ç›–ç‡ï¼Ÿ

**A:** Bootstrap æ¶æ„å¤©ç„¶æ”¯æŒé«˜è¦†ç›–ç‡ï¼š

```typescript
// âœ… æ¯ä¸ªæ’ä»¶éƒ½å¯ä»¥ç‹¬ç«‹æµ‹è¯•
describe('UserService', () => {
  it('should initialize user', async () => {
    const service = new UserService(mockApi, mockStorage, mockRouter);
    await service.onBefore();
    expect(mockApi.getUserInfo).toHaveBeenCalled();
  });

  // æ˜“äºæµ‹è¯•æ‰€æœ‰è¾¹ç•Œæƒ…å†µ
  it('should handle missing token', async () => {
    mockStorage.getItem.mockReturnValue(null);
    await expect(service.onBefore()).rejects.toThrow('NO_USER_TOKEN');
  });

  it('should handle API error', async () => {
    mockApi.getUserInfo.mockRejectedValue(new Error('Network error'));
    await expect(service.onBefore()).rejects.toThrow('Network error');
  });
});
```

**è¦†ç›–ç‡ç›®æ ‡ï¼š**

- æ’ä»¶é€»è¾‘ï¼š> 90%
- æœåŠ¡å±‚ï¼š> 85%
- API é€‚é…å™¨ï¼š> 80%

### Q7: Vitest å’Œ Jest æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

**A:** æœ¬é¡¹ç›®ä½¿ç”¨ Vitestï¼Œå®ƒæ˜¯ Vite ç”Ÿæ€çš„æµ‹è¯•æ¡†æ¶ï¼š

| ç‰¹æ€§         | Vitest                        | Jest         |
| ------------ | ----------------------------- | ------------ |
| **é€Ÿåº¦**     | âš¡ éå¸¸å¿«ï¼ˆåŸºäº Viteï¼‰        | æ…¢           |
| **é…ç½®**     | ğŸ¯ é›¶é…ç½®ï¼ˆå¤ç”¨ vite.configï¼‰ | éœ€è¦å•ç‹¬é…ç½® |
| **ESM æ”¯æŒ** | âœ… åŸç”Ÿæ”¯æŒ                   | âš ï¸ å®éªŒæ€§    |
| **API**      | ä¸ Jest å…¼å®¹                  | -            |
| **HMR**      | âœ… æ”¯æŒ                       | âŒ ä¸æ”¯æŒ    |

```typescript
// Vitest ä½¿ç”¨æ–¹å¼ï¼ˆä¸ Jest å‡ ä¹ç›¸åŒï¼‰
import { describe, it, expect, vi, beforeEach } from 'vitest';

describe('MyTest', () => {
  beforeEach(() => {
    vi.clearAllMocks();
  });

  it('should work', () => {
    expect(true).toBe(true);
  });
});
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [é¡¹ç›®æ¶æ„è®¾è®¡](./index.md) - äº†è§£æ•´ä½“æ¶æ„
- [IOC å®¹å™¨](./ioc.md) - ä¾èµ–æ³¨å…¥è¯¦è§£
- [ç¯å¢ƒå˜é‡](./env.md) - ç¯å¢ƒé…ç½®ç®¡ç†
- [å…¨å±€å˜é‡å°è£…](./global.md) - æµè§ˆå™¨ API å°è£…

---

## ğŸ‰ æ€»ç»“

Bootstrap å¯åŠ¨å™¨æ˜¯ç°ä»£å‰ç«¯æ¶æ„çš„é‡è¦ç»„æˆéƒ¨åˆ†ï¼Œå®ƒå¸®åŠ©æˆ‘ä»¬ï¼š

1. **åˆ†ç¦»å…³æ³¨ç‚¹** - UI å’Œåˆå§‹åŒ–é€»è¾‘åˆ†ç¦»
2. **æé«˜å¯ç»´æŠ¤æ€§** - æ¨¡å—åŒ–è®¾è®¡ï¼ŒèŒè´£æ¸…æ™°
3. **å¢å¼ºå¯æµ‹è¯•æ€§** - æ¯ä¸ªæ’ä»¶å¯ç‹¬ç«‹æµ‹è¯•
4. **æ”¯æŒå›¢é˜Ÿåä½œ** - ä¸åŒå¼€å‘è€…å¯ä»¥ç‹¬ç«‹å¼€å‘æ’ä»¶
5. **é€‚åº”å˜åŒ–** - æ˜“äºæ‰©å±•å’Œä¿®æ”¹

é€šè¿‡ Bootstrapï¼Œæˆ‘ä»¬æ„å»ºäº†ä¸€ä¸ªæ›´åŠ å¥å£®ã€å¯ç»´æŠ¤ã€å¯æµ‹è¯•çš„å‰ç«¯åº”ç”¨æ¶æ„ã€‚

---

**é—®é¢˜åé¦ˆï¼š**  
å¦‚æœä½ å¯¹ Bootstrap æœ‰ä»»ä½•ç–‘é—®æˆ–å»ºè®®ï¼Œè¯·åœ¨å›¢é˜Ÿé¢‘é“ä¸­è®¨è®ºæˆ–æäº¤ Issueã€‚
