# 国际化 (i18n) 指南

本文档将详细介绍项目中的国际化实现，包括 API 错误信息、页面内容以及所有需要多语言支持的文本内容。

## 目录

- [基础配置](#基础配置)
- [API 错误信息处理](#api-错误信息处理)
- [页面内容国际化](#页面内容国际化)
- [使用规范](#使用规范)

## 基础配置

项目使用 next-intl 进行国际化管理，配置文件位于 `config/i18n/i18nConfig.ts`：

```typescript
export const i18nConfig = {
  localeNames: {
    en: 'English',
    zh: '中文'
  },
  fallbackLng: 'en',
  supportedLngs: ['en', 'zh'],
  localeDetection: true
};
```

所有支持的语言都在 `supportedLngs` 中定义，默认语言为 `fallbackLng` 指定的语言。

## API 错误信息处理

API 错误信息的国际化处理流程如下：

1. API 响应格式：

```typescript
interface AppApiErrorInterface {
  success: false;
  id: string; // i18n key
  message?: string; // 可选的直接显示消息
}
```

2. 错误处理流程：
   - API 请求通过 `AppApiPlugin` 处理响应
   - 如果响应表示错误，错误信息会被转换为 `ExecutorError`
   - `DialogErrorPlugin` 负责显示错误消息
   - 如果错误消息是 i18n key 格式（如 "namespace_key"），则会通过 i18n 服务翻译后显示
   - 如果不是 i18n key 格式，则直接显示原始消息

示例：

```typescript
// API 返回错误
{
  success: false,
  id: "error_invalid_password"
}

// DialogErrorPlugin 会自动翻译并显示对应语言的错误信息
```

## 页面内容国际化

### PageI18nInterface

`PageI18nInterface` 是一个核心接口，用于定义页面的国际化内容和 SEO 元数据。这个接口提供了完整的页面元数据结构，包括基本 SEO 信息、Open Graph、Twitter Card 等。

```typescript
interface PageI18nInterface {
  // 基本元数据属性
  title: string; // 页面标题
  description: string; // 页面描述
  content: string; // 页面内容
  keywords: string; // 页面关键词

  // 规范链接
  canonical?: string; // 可选的规范链接

  // 爬虫控制
  robots?: {
    index?: boolean; // 是否允许索引
    follow?: boolean; // 是否跟随链接
    noarchive?: boolean; // 是否允许存档
  };

  // Open Graph 元数据
  og?: {
    title?: string; // OG 标题
    description?: string; // OG 描述
    type?: string; // 内容类型
    image?: string; // 图片 URL
    url?: string; // 页面 URL
    siteName?: string; // 站点名称
    locale?: string; // 语言地区
  };

  // Twitter Card 元数据
  twitter?: {
    card?: 'summary' | 'summary_large_image' | 'app' | 'player'; // 卡片类型
    site?: string; // Twitter 站点
    creator?: string; // 创建者
    title?: string; // Twitter 标题
    description?: string; // Twitter 描述
    image?: string; // Twitter 图片
  };

  // 附加元数据
  author?: string; // 作者
  publishedTime?: string; // 发布时间
  modifiedTime?: string; // 修改时间
}
```

使用说明：

1. 所有字符串类型的值都可以是：
   - i18n key：将会被翻译成当前语言
   - 直接字符串：将直接使用，不进行翻译
2. 可选字段（带 `?` 的字段）表示该页面可以不包含这些元数据
3. 这个接口通常用于：
   - 定义页面的 SEO 信息
   - 生成 meta 标签
   - 提供社交媒体分享信息
   - 控制搜索引擎爬虫行为

### 在页面中使用 PageI18nInterface

以下是一个完整的页面示例，展示如何使用 PageI18nInterface：

```typescript
// 1. 首先定义页面的 i18n 接口
export const homeI18n = Object.freeze({
  title: i18nKeys.PAGE_HOME_TITLE,
  description: i18nKeys.PAGE_HOME_DESCRIPTION,
  content: i18nKeys.PAGE_HOME_DESCRIPTION,
  keywords: i18nKeys.PAGE_HOME_KEYWORDS,

  welcome: i18nKeys.HOME_WELCOME,
  getStartedTitle: i18nKeys.HOME_GET_STARTED_TITLE,
  getStartedDescription: i18nKeys.HOME_GET_STARTED_DESCRIPTION,
  getStartedButton: i18nKeys.HOME_GET_STARTED_BUTTON
});

// 2. 在页面中使用
export async function generateMetadata({ params }: { params: PageParamsType }): Promise<Metadata> {
  const pageParams = new PageParams(await params);
  // 获取页面 SEO 元数据
  return await pageParams.getI18nInterface(homeI18n);
}

export default async function HomePage({ params }: PageParamsProps) {
  const pageParams = new PageParams(await params!);
  // 获取页面翻译内容
  const tt = await pageParams.getI18nInterface(homeI18n);

  return (
    <BaseLayout>
      <section>
        <h1>{tt.welcome}</h1>
        <p>{tt.description}</p>
        <div>
          <h2>{tt.getStartedTitle}</h2>
          <p>{tt.getStartedDescription}</p>
          <Button>{tt.getStartedButton}</Button>
        </div>
      </section>
    </BaseLayout>
  );
}
```

这个示例展示了：

1. 如何定义页面特定的 i18n 接口
2. 如何使用 `getI18nInterface` 获取翻译后的内容
3. 如何在页面元数据中使用 i18n
4. 如何在页面组件中使用翻译的内容

### 实现页面国际化

页面内容的国际化主要通过以下方式实现：

1. 页面 i18n 接口定义：

```typescript
// config/i18n/HomeI18n.ts
export const homeI18n = Object.freeze({
  title: i18nKeys.PAGE_HOME_TITLE,
  description: i18nKeys.PAGE_HOME_DESCRIPTION,
  welcome: i18nKeys.HOME_WELCOME
  // ...
});
```

2. 获取翻译内容：

```typescript
// 在页面组件中
const messages = await getMessages({ locale });
// 或者使用 PageParams
const i18nContent = await pageParams.getI18nInterface(homeI18n);
```

3. 动态路由中的语言处理：

```typescript
// src/app/[locale]/layout.tsx
export default async function RootLayout({ children, params }) {
  const pageParams = new PageParams(params);
  const locale = pageParams.getI18nWithNotFound();
  // ...
}
```

## 使用规范

1. **所有文本内容必须使用 i18n key**：
   - 不要直接在代码中写入固定文本
   - 所有文本都应该定义在 i18n 配置文件中
   - 使用有意义的 key 名称，如：`PAGE_HOME_TITLE`、`ERROR_INVALID_INPUT`

2. **i18n key 命名规范**：
   - 使用大写字母和下划线
   - 使用有意义的前缀表示分类，如：
     - `PAGE_` 前缀表示页面相关
     - `ERROR_` 前缀表示错误信息
     - `COMMON_` 前缀表示通用文本

3. **翻译文件组织**：
   - 翻译文件位于 `public/locales/` 目录
   - 按语言代码分类：`en.json`、`zh.json`
   - 保持所有语言文件的 key 一致

4. **类型安全**：
   - 使用 TypeScript 接口定义 i18n 内容
   - 所有 i18n key 都应该在 `config/Identifier/` 目录下定义
   - 使用 `Object.freeze` 确保 i18n 对象不被修改

5. **最佳实践**：
   - 使用 `PageParams` 类处理页面的语言相关逻辑
   - 在组件中使用 `useTranslations` hook 获取翻译
   - API 错误信息优先使用 i18n key，而不是硬编码的消息
   - 确保所有用户可见的文本都支持多语言

## 示例

1. 页面组件中使用 i18n：

```typescript
export function LoginForm(props: { tt: LoginI18nInterface }) {
  const { tt } = props;

  return (
    <form>
      <h1>{tt.title}</h1>
      <p>{tt.description}</p>
      {/* ... */}
    </form>
  );
}
```

2. API 错误处理：

```typescript
// 后端返回错误
throw new AppErrorApi({
  id: 'ERROR_INVALID_CREDENTIALS',
  success: false
});

// 前端自动处理并显示翻译后的错误消息
```

3. 动态内容：

```typescript
const t = await getTranslations({
  locale: pageParams.getLocale(),
  namespace: 'common'
});

const message = t('welcome', {
  name: userName
});
```
